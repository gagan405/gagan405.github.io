<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://notes.minbox.in name=base><title>
            
                Migrating a legacy service from Java 8 to Java 17
            
        </title><meta content="Migrating a legacy service from Java 8 to Java 17" property=og:title><link href=https://notes.minbox.in/icon/favicon.png rel=icon type=image/png><link href=https://notes.minbox.in/fonts.css rel=stylesheet><script defer src=https://notes.minbox.in/js/codeblock.js></script><script defer src=https://notes.minbox.in/js/toc.js></script><script defer src=https://notes.minbox.in/js/note.js></script><script>MathJax = {
                    tex: {
                        inlineMath: [
                            ['$', '$'],
                            ['\\(', '\\)']
                        ]
                    }
                };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="
    gb mishra
" href=https://notes.minbox.in/atom.xml rel=alternate type=application/atom+xml><link title="
    gb mishra
" href=https://notes.minbox.in/rss.xml rel=alternate type=application/rss+xml><link href=https://notes.minbox.in/theme/light.css rel=stylesheet><link href=https://notes.minbox.in/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://notes.minbox.in/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://notes.minbox.in/main.css media=screen rel=stylesheet><script src="https://notes.minbox.in/search_index.en.js?h=966bd9498bd4e08435c0" defer></script><script src="https://notes.minbox.in/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=left-content></div><div class=content><nav><div class=left-nav><a href=https://notes.minbox.in>gb mishra</a><div class=socials><a class=social href=https://x.com/__gbm rel=me> <img alt=twitter src=https://notes.minbox.in/icons/social/twitter.svg> </a><a class=social href=https://github.com/gagan405/ rel=me> <img alt=github src=https://notes.minbox.in/icons/social/github.svg> </a><a class=social href=/atom.xml rel=me> <img alt=rss src=https://notes.minbox.in/icons/social/rss.svg> </a></div></div><div class=right-nav><a href=https://notes.minbox.in/posts style=margin-right:.5em>/posts</a><a href=https://notes.minbox.in/tags style=margin-right:.5em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://notes.minbox.in/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://notes.minbox.in/icons/sun.svg> <img alt=Dark id=moon-icon src=https://notes.minbox.in/icons/moon.svg style=filter:invert()> <img alt=Auto id=auto-icon src=https://notes.minbox.in/icons/auto.svg style=filter:invert()> </a><script>updateItemToggleTheme()</script></div></nav><div data-selector="main article p" class=visible-element-observer-root><main><article><div class=title><div class=page-header>Migrating a legacy service from Java 8 to Java 17</div><div class=meta>Posted on <time>2023-03-13</time><span class=tags-label>::</span><span class=tags> <a class=post-tag href=https://notes.minbox.in/tags/java/>java</a> <a class=post-tag href=https://notes.minbox.in/tags/powermock/>powermock</a> <a class=post-tag href=https://notes.minbox.in/tags/jdk/>jdk</a> <a class=post-tag href=https://notes.minbox.in/tags/migration/>migration</a> </span></div></div><section class=body><p>I just migrated a legacy service from Java 8 to 17 and it was a smooth experience, except for a few. Here are some lessons learnt in the process.<p>Before anything else, this shows the improvements in the overall GC time after JDK17 migration.<p><img alt="gc improvements" src=https://notes.minbox.in/posts/jdk-migration/./jdk-gc-improvements.webp><p><em>Impressive, isn’t it?</em><p>Java 17 has a lot of changes when compared to Java 8, of course. And the most important one seems to be the <a href=https://blogs.oracle.com/javamagazine/post/a-peek-into-java-17-continuing-the-drive-to-encapsulate-the-java-runtime-internals>strongly encapsulated JDK internals</a>.<p>So, how does it matter to you, as a service code author, who rarely does any playing around with JDK internal APIs?<p>Well, we probably don't use them directly. But they could be used through other useful libraries that we use: such as EasyMock/JaxB/PowerMock etc.<p>The process is quite simple though. And here I try to summarize:<h2 id=use-top-down-migration><strong>Use Top-Down migration</strong></h2><p>Code written and compiled in JDK8/11 will work as a dependency in a package compiled in 17. But we cannot have it the other way round. So, if you have some top level package/service; start with that.<h2 id=upgrade-dependency-to-jdk-17-and-fix-broken-packages><strong>Upgrade dependency to JDK-17 and fix broken packages</strong></h2><p>Certain packages that I found breaking were:<ul><li>PowerMock<li>EasyMock-4.x</ul><h2 id=remove-powermock><strong>Remove PowerMock</strong></h2><p>PowerMock has been used primarily to mock:<ol><li>Static methods<li>Final classes<li>Mocking constructors</ol><p>While most of it could be achieved through <code>Mockito-5.*</code> and <code>mockito-inline</code>, it is a good opportunity to re-visit the necessity of such tests. In general, if you need a bytecode mingling library such as PowerMock to test a static method; isn't that a sign of poor code design?<p>There are many articles on the web explaining why you shouldn't be using PowerMock. So, read through them and convince yourself. Examples: <a href=https://automationrhapsody.com/powermock-examples-better-not-use/>this</a>, <a href=https://medium.com/@inderivita/powermock-testing-tool-or-testing-obstacle-29f3303c9337>this</a> and <a href="https://news.ycombinator.com/item?id=8775233">this</a>.<p>So, in such cases, I would ask myself:<ul><li>Can I refactor the code structure to not have static utility classes?<li>Can I <em>not mock</em> static methods and go ahead with testing them as part of unit tests.<li>Can the <code>new Object(...)</code> code portions be abstracted out to dependency injection frameworks so that I dont have to test those?<li>Do I really need final classes?</ul><p>Many such cases could essentially be refactored out for a better manageable code that wouldn't really require such a library in the first place.<p><em><strong>Stateless simple static methods</strong></em><p>If static util method is something similar to <code>StringUtils.isNotNull()</code>, then don’t mock it and let it execute the real method.<p><em><strong>Complex static methods</strong></em><p>If the static util method does complex stuff within the utility method, such as n/w calls, FileIO, or some complicated computation: explore options of refactoring. Easiest way is to just make it non-static and have it as an object injected to the consumer class.<p><strong>Static methods from Thread/System classes:</strong><p>If the static method is using System or Thread methods or <a href=https://blog.frankel.ch/on-powermock-abuse/>native methods</a>, such as <code>Thread.sleep()</code> , <code>mockito-inline</code> does not support mocking those methods and consider creating wrapper classes over such methods.<p>Example:<pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span style=color:#b48ead>public class </span><span style=color:#ebcb8b>Delayer </span><span style=color:#eff1f5>{
</span><span style=color:#eff1f5>    </span><span style=color:#b48ead>public void </span><span style=color:#8fa1b3>delay</span><span style=color:#eff1f5>(</span><span style=color:#b48ead>long </span><span style=color:#bf616a>millis</span><span style=color:#eff1f5>) </span><span style=color:#b48ead>throws </span><span style=color:#ebcb8b>InterruptedException </span><span style=color:#eff1f5>{
</span><span style=color:#eff1f5>        </span><span style=color:#ebcb8b>Thread</span><span style=color:#eff1f5>.</span><span style=color:#bf616a>sleep</span><span style=color:#eff1f5>(millis);
</span><span style=color:#eff1f5>    }
</span><span style=color:#eff1f5>}
</span></code></pre><p><em><strong>Static methods using Date Times</strong></em><p>If the static methods rely on date time, consider using <code>mockMethods</code> in the real class and call those from the tests. Credit where due: <a href=https://dzone.com/articles/mock-java-datetime-for-testing>Reference on the below snippet</a><pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span style=color:#b48ead>private static </span><span style=color:#ebcb8b>Clock </span><span style=color:#d08770>CLOCK </span><span>= </span><span style=color:#ebcb8b>Clock</span><span>.</span><span style=color:#bf616a>systemDefaultZone</span><span>();
</span><span style=color:#b48ead>private static final </span><span style=color:#ebcb8b>TimeZone </span><span style=color:#d08770>REAL_TIME_ZONE </span><span>= </span><span style=color:#ebcb8b>TimeZone</span><span>.</span><span style=color:#bf616a>getDefault</span><span>();
</span><span>
</span><span style=color:#65737e>// Call this method in your test cases
</span><span style=color:#b48ead>public static</span><span> void </span><span style=color:#bf616a>useMockTime</span><span>(</span><span style=color:#ebcb8b>LocalDateTime</span><span> dateTime, </span><span style=color:#ebcb8b>ZoneId</span><span> zoneId) {
</span><span>    </span><span style=color:#ebcb8b>Instant</span><span> instant = dateTime.</span><span style=color:#bf616a>atZone</span><span>(zoneId).</span><span style=color:#bf616a>toInstant</span><span>();
</span><span>    </span><span style=color:#d08770>CLOCK </span><span>= </span><span style=color:#ebcb8b>Clock</span><span>.</span><span style=color:#bf616a>fixed</span><span>(instant, zoneId);
</span><span>    </span><span style=color:#ebcb8b>TimeZone</span><span>.</span><span style=color:#bf616a>setDefault</span><span>(</span><span style=color:#ebcb8b>TimeZone</span><span>.</span><span style=color:#bf616a>getTimeZone</span><span>(zoneId));
</span><span>}
</span><span>
</span><span style=color:#65737e>// call this method to reset the clock back
</span><span style=color:#b48ead>public static</span><span> void </span><span style=color:#bf616a>useSystemDefaultZoneClock</span><span>() {
</span><span>    </span><span style=color:#ebcb8b>TimeZone</span><span>.</span><span style=color:#bf616a>setDefault</span><span>(</span><span style=color:#d08770>REAL_TIME_ZONE</span><span>);
</span><span>    </span><span style=color:#d08770>CLOCK </span><span>= </span><span style=color:#ebcb8b>Clock</span><span>.</span><span style=color:#bf616a>systemDefaultZone</span><span>();
</span><span>}
</span></code></pre><p><strong>NOTE</strong> : The above also introduced me to a very cool library <a href=https://www.archunit.org/><code>archunit</code></a> library. Also, I spent at least 2 hours in getting the regex working for intellij test directory:<pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span style=color:#b48ead>private static final </span><span style=color:#ebcb8b>Pattern </span><span style=color:#d08770>IDEA_TEST_PATTERN </span><span>= </span><span style=color:#ebcb8b>Pattern</span><span>.</span><span style=color:#bf616a>compile</span><span>("</span><span style=color:#a3be8c>.*/out/test/([^/]+/)+?[a-zA-Z]+Tests?.*</span><span>");
</span></code></pre><p><em>CAUTION :</em><p>In <code>junit4</code> the expected exceptions are written at the top level such as this:<pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span>@</span><span style=color:#bf616a>Test</span><span>(</span><span style=color:#bf616a>expected </span><span>= </span><span style=color:#ebcb8b>SomeException</span><span>.</span><span style=color:#bf616a>class</span><span>) {
</span><span>    </span><span style=color:#bf616a>useMockTime</span><span>(currentDateTime, zoneId);
</span><span>    ...
</span><span>    ...
</span><span>    </span><span style=color:#bf616a>useSystemDefaultZoneClock</span><span>();
</span><span>}
</span></code></pre><p>The above will <strong>NOT</strong> work as the final statement will not get executed due to the exception above. To handle these:<ul><li>Use <code>try...catch</code> and then reset<li>Use AssertJ library method <a href=https://www.javadoc.io/doc/org.assertj/assertj-core/3.8.0/org/assertj/core/api/Assertions.html#assertThatThrownBy-org.assertj.core.api.ThrowableAssert.ThrowingCallable->assertThatThrownBy</a><li>OR simply use <code>Junit5</code>: <code>assertThrows(SomeException.class, () -> someMethodWhichThrowsException());</code></ul><p><em><strong>Mocking new instantiations</strong></em><p>Refactor to not have such cases and use Dependency Injection. Take advantage of DI frameworks and try refactoring the code in a way that you wouldn’t need such cases. If that’s not an option, see below.<p>Use Mockito <a href=https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html#mocked_construction><code>mockConstruction</code></a> Note that mockConstruction doesn’t support argument captor. So, if you want to validate that a certain class was instantiated with a specific type params, you would need to pass a supplier to capture the constructor args, and then assert those. Sample as <a href=https://groups.google.com/g/mockito/c/WqPlcNrvbOw/m/0WzhI51sAgAJ>this</a>.<p>This approach looks un-maintanable, but I am not aware of any better approach yet.<h2 id=removing-easymock><strong>Removing EasyMock</strong></h2><p>EasyMock-5.x is <a href=https://github.com/easymock/easymock/pull/300>supposed to work</a> with JDK-17. But do you really need to have 2 separate mocking libraries in your dependency closure? Choose one and stick to it preferably. That makes the test cases consistent and uniform across the project.<h2 id=issues-with-errorprone><strong>Issues With ErrorProne</strong></h2><p>ErrorProne doesnt work well with Java17 and there are a few open issues such as https://github.com/google/error-prone/issues/1250<p>This mostly comes from Lombok generated files not working well with ErrorProne. Some of them are not solved even after adding Generated annotation or using jvmargs specified in the above issue.<h2 id=checkstyle><strong>CheckStyle</strong></h2><p>The classic CheckStyle rules do not work with Java17. Some of the module hierarchy have changed. The rules need to be updated. Refer to the latest <a href=https://checkstyle.sourceforge.io/index.html>checkstyle rules</a> and fix them!<p><em><strong>Formatting changes in git</strong></em><p>As part of checkstyle upgrade, if you are also reformatting your code, then you might want to ignore such commits appearing in your git blame (IntelliJ annotations). To do that, you can use this git config changes. <a href=https://tekin.co.uk/2020/09/ignore-linting-and-formatting-commits-when-running-git-blame>Here</a> is an article with instructions.<h2 id=runtime-tests><strong>Runtime tests</strong></h2><p>When all the tests and builds are going fine, its time to do a runtime test. There could still be errors in runtime due to who knows what library accessing internal JDK APIs! One such error I found was with Jaxb:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>Caused by: java.lang.IllegalStateException: Unable to initialize jaxbContext
</span></code></pre><p>Solution is simple. Just add the dependencies to <a href=https://mvnrepository.com/artifact/javax.xml.bind/jaxb-api>Jaxb-api</a>.<p>Also, JaxB legacy properties have been deprecated long, and they need to be replaced with their upgraded counterparts. For example:<pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span style=color:#ebcb8b>Marshaller</span><span> marshaller = jaxbContext.</span><span style=color:#bf616a>createMarshaller</span><span>();
</span><span>marshaller.</span><span style=color:#bf616a>setProperty</span><span>("</span><span style=color:#a3be8c>com.sun.xml.internal.bind.xmlDeclaration</span><span>", </span><span style=color:#ebcb8b>Boolean</span><span>.</span><span style=color:#d08770>FALSE</span><span>);
</span></code></pre><p>the above snippet needs to be changed to<pre class=language-java data-lang=java style=color:#c0c5ce;background-color:#2b303b><code class=language-java data-lang=java><span style=color:#ebcb8b>Marshaller</span><span> marshaller = jaxbContext.</span><span style=color:#bf616a>createMarshaller</span><span>();
</span><span>marshaller.</span><span style=color:#bf616a>setProperty</span><span>(</span><span style=color:#ebcb8b>Marshaller</span><span>.</span><span style=color:#d08770>JAXB_FRAGMENT</span><span>, </span><span style=color:#ebcb8b>Boolean</span><span>.</span><span style=color:#d08770>FALSE</span><span>);
</span></code></pre><p>Similarly, many of the old JVM args are now deprecated and that would cause the service to fail to start. Those can simply be ignored by using the flag <code>-XX:+IgnoreUnrecognizedVMOptions</code><p><strong>Validation</strong><p>Verify how JDK17 is performing with live traffic. What should be the GC/ JVM params and so on.<h2 id=conclusion><strong>Conclusion</strong></h2><p>There you have it. Service running with Java 17! Enjoy the optimizations and new language features. Happy Coding!</section></article></main></div></div><div class=right-content><div class=toc><div class=heading>Table of Contents</div><ul class=toc-list><li class=parent><a href=https://notes.minbox.in/posts/jdk-migration/#use-top-down-migration>Use Top-Down migration</a><li class=parent><a href=https://notes.minbox.in/posts/jdk-migration/#upgrade-dependency-to-jdk-17-and-fix-broken-packages>Upgrade dependency to JDK-17 and fix broken packages</a><li class=parent><a href=https://notes.minbox.in/posts/jdk-migration/#remove-powermock>Remove PowerMock</a><li class=parent><a href=https://notes.minbox.in/posts/jdk-migration/#removing-easymock>Removing EasyMock</a><li class=parent><a href=https://notes.minbox.in/posts/jdk-migration/#issues-with-errorprone>Issues With ErrorProne</a><li class=parent><a href=https://notes.minbox.in/posts/jdk-migration/#checkstyle>CheckStyle</a><li class=parent><a href=https://notes.minbox.in/posts/jdk-migration/#runtime-tests>Runtime tests</a><li class=parent><a href=https://notes.minbox.in/posts/jdk-migration/#conclusion>Conclusion</a></ul></div></div>