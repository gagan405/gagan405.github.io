<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://gagan405.github.io name=base><title>
            
                Hibernate, Flush Mode, and Broken Invoice Numbers
            
        </title><meta content="Hibernate, Flush Mode, and Broken Invoice Numbers" property=og:title><link href=https://gagan405.github.io/icon/favicon.png rel=icon type=image/png><link href=https://gagan405.github.io/fonts.css rel=stylesheet><script defer src=https://gagan405.github.io/js/codeblock.js></script><script defer src=https://gagan405.github.io/js/toc.js></script><script defer src=https://gagan405.github.io/js/note.js></script><script>MathJax = {
                    tex: {
                        inlineMath: [
                            ['$', '$'],
                            ['\\(', '\\)']
                        ]
                    }
                };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="
    gb mishra
" href=https://gagan405.github.io/atom.xml rel=alternate type=application/atom+xml><link title="
    gb mishra
" href=https://gagan405.github.io/rss.xml rel=alternate type=application/rss+xml><link href=https://gagan405.github.io/theme/light.css rel=stylesheet><link href=https://gagan405.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://gagan405.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://gagan405.github.io/main.css media=screen rel=stylesheet><script src="https://gagan405.github.io/search_index.en.js?h=ed7db15dd4fde6e35f9a" defer></script><script src="https://gagan405.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=left-content></div><div class=content><nav><div class=left-nav><a href=https://gagan405.github.io>gb mishra</a><div class=socials><a class=social href=https://x.com/__gbm rel=me> <img alt=twitter src=https://gagan405.github.io/icons/social/twitter.svg> </a><a class=social href=https://github.com/gagan405/ rel=me> <img alt=github src=https://gagan405.github.io/icons/social/github.svg> </a><a class=social href=/atom.xml rel=me> <img alt=rss src=https://gagan405.github.io/icons/social/rss.svg> </a></div></div><div class=right-nav><a href=https://gagan405.github.io/posts style=margin-right:.5em>/posts</a><a href=https://gagan405.github.io/tags style=margin-right:.5em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://gagan405.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://gagan405.github.io/icons/sun.svg> <img alt=Dark id=moon-icon src=https://gagan405.github.io/icons/moon.svg style=filter:invert()> <img alt=Auto id=auto-icon src=https://gagan405.github.io/icons/auto.svg style=filter:invert()> </a><script>updateItemToggleTheme()</script></div></nav><div data-selector="main article p" class=visible-element-observer-root><main><article><div class=title><div class=page-header>Hibernate, Flush Mode, and Broken Invoice Numbers</div><div class=meta>Posted on <time>2025-12-30</time><span class=tags-label>::</span><span class=tags> <a class=post-tag href=https://gagan405.github.io/tags/orm/>orm</a> <a class=post-tag href=https://gagan405.github.io/tags/hibernate/>hibernate</a> <a class=post-tag href=https://gagan405.github.io/tags/sql/>sql</a> </span></div></div><section class=body><p>(This was something I debugged a decade ago, in Seller Platform Services at Flipkart. I don’t exactly remember the Hibernate version or detailed configurations, like isolation levels. The below is the best I could do with my memory.)<h2 id=the-problem>The Problem</h2><p>We discovered that invoice numbers were being generated out of sequence for shipments containing multiple orders.<p>Instead of clean sequences like:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>inv-1, inv-2, inv-3
</span></code></pre><p>we occasionally saw results such as:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>inv-1, inv-2, inv-125574
</span></code></pre><p>This only happened for shipments with multiple orders, and the pattern was inconsistent across environments, sometimes all invoices were wrong, sometimes only one, and sometimes none at all.<h2 id=how-invoice-numbers-were-generated>How Invoice Numbers Were Generated</h2><p>At the time, invoice numbers were generated using a custom sequence table and MySQL’s LAST_INSERT_ID() function.<p>The flow looked like this:<ol><li>Increment the sequence:</ol><pre class=language-sql data-lang=sql style=color:#c0c5ce;background-color:#2b303b><code class=language-sql data-lang=sql><span style=color:#b48ead>update</span><span> invoice_sequence
</span><span style=color:#b48ead>set</span><span> next_value = LAST_INSERT_ID(next_value) + </span><span style=color:#d08770>1
</span><span style=color:#b48ead>where</span><span> id = :id;
</span></code></pre><ol start=2><li>Fetch the generated value:</ol><pre class=language-sql data-lang=sql style=color:#c0c5ce;background-color:#2b303b><code class=language-sql data-lang=sql><span style=color:#b48ead>select</span><span> LAST_INSERT_ID();
</span></code></pre><ol start=3><li>Insert the invoice number into <code>InvoiceNumber</code><li>Insert an outbound message into another table (to notify other consumers of invoice event)</ol><h2 id=the-key-assumption>The Key Assumption</h2><p>This logic only works if <strong>steps 1 and 2 execute atomically</strong>, i.e., with no inserts happening in between. Otherwise, LAST_INSERT_ID() can change.<h2 id=what-went-wrong>What Went Wrong</h2><h3 id=hibernate-flush-behavior>Hibernate Flush Behavior</h3><p>For shipments with multiple orders, this logic ran <strong>inside a loop</strong>.<p>Hibernate (JPA), for performance reasons, does not immediately execute insert statements. Instead, it queues them and flushes later. Either:<ul><li>at transaction commit, or<li>automatically before executing certain queries.</ul><p>This led to a subtle but fatal interaction.<h3 id=why-last-insert-id-broke>Why LAST_INSERT_ID() Broke</h3><p>In MySQL:<ul><li><p>If an insert happens on a table with an AUTO_INCREMENT column, it overwrites LAST_INSERT_ID().</p><li><p>If the table has no auto-increment, LAST_INSERT_ID() becomes 0.</p></ul><p>Hibernate sometimes flushed pending inserts between:<ul><li>the sequence update, and<li>the <code>select LAST_INSERT_ID()</code> call.</ul><p>When that happened, the invoice number suddenly came from an entirely different table.<h2 id=observed-behavior-in-different-environments>Observed Behavior in Different Environments</h2><p>Because Hibernate’s default flush mode is AUTO, the timing was unpredictable.<p>We observed several patterns:<h3 id=a-local-environment>a) Local Environment</h3><p>For a shipment with 3 orders:<ul><li>The first invoice was correct<li>The next two were wrong</ul><p>Hibernate flushed inserts right before the next iteration’s <code>select LAST_INSERT_ID()</code>, corrupting the value.<h3 id=b-production-flush-only-at-commit>b) Production – Flush Only at Commit</h3><p>Some shipments flushed only when the transaction closed. No errors occurred<h3 id=c-flush-at-the-last-order>c) Flush at the Last Order</h3><p>Hibernate flushed inserts only during the final iteration. Only the last invoice was corrupted: in 10 orders, only the last one was corrupt<h3 id=d-flush-mid-loop>d) Flush Mid-Loop</h3><p>Hibernate flushed somewhere in the middle.<ul><li>One random order was corrupted<li>Example: 4 orders, 2nd one corrupted</ul><p>There was no fixed pattern.<h2 id=why-this-happened>Why This Happened</h2><p>Hibernate always flushes before executing a <strong>native query</strong>.<p>Since <code>select LAST_INSERT_ID()</code> is a native query, Hibernate triggered a flush—but only if there were pending inserts.<p>This behavior is documented and consistent with Hibernate’s implementation:<ul><li>Default flush mode: AUTO<li>Meaning: Hibernate may flush “sometimes”</ul><h2 id=impact>Impact</h2><ul><li>Shipments with multiple orders generated invalid invoice numbers<li>Invoice sequences jumped unexpectedly<li>Downstream systems were affected due to incorrect invoice references</ul><h2 id=the-fix>The Fix</h2><p>We made two key changes:<h3 id=1-removed-last-insert-id-entirely>1. Removed LAST_INSERT_ID() Entirely</h3><ul><li>Replaced the update/select logic with a <code>SELECT … FOR UPDATE</code> on the sequence row<li>Ensured correctness without relying on session-level side effects</ul><h3 id=2-generate-invoice-numbers-in-one-shot>2. Generate Invoice Numbers in One Shot</h3><p>Instead of generating numbers inside a loop<ul><li><p>We queried and reserved all required invoice numbers once per shipment</p><li><p>This eliminated flush-related timing issues completely.</p></ul><h2 id=why-tests-didn-t-catch-it>Why Tests Didn’t Catch It</h2><ul><li><p>Unit tests used mocked databases</p><li><p>Mock DBs don’t replicate:</p> <ul><li><code>LAST_INSERT_ID()</code> semantics<li>Hibernate flush timing</ul><li><p>The issue was non-deterministic, making it nearly impossible to catch with small test runs</p><li><p>Integ tests missing multiple orders in one shipment</p></ul><h2 id=lessons-learned>Lessons Learned</h2><ul><li>Never rely on LAST_INSERT_ID() across multiple statements unless they are truly atomic<li>ORM flush behavior matters, especially with native queries<li>Mocked DB tests are insufficient for sequence and concurrency bugs<li>Prefer explicit locking (FOR UPDATE) or database-native sequences<li>Generate identifiers outside loops whenever possible<li>Run integration tests with all possible scenarios</ul></section></article></main></div></div><div class=right-content><div class=toc><div class=heading>Table of Contents</div><ul class=toc-list><li class=parent><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#the-problem>The Problem</a><li class=parent><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#how-invoice-numbers-were-generated>How Invoice Numbers Were Generated</a><li class=parent><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#the-key-assumption>The Key Assumption</a><li class=parent><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#what-went-wrong>What Went Wrong</a> <ul><li><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#hibernate-flush-behavior>Hibernate Flush Behavior</a><li><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#why-last-insert-id-broke>Why LAST_INSERT_ID() Broke</a></ul><li class=parent><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#observed-behavior-in-different-environments>Observed Behavior in Different Environments</a> <ul><li><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#a-local-environment>a) Local Environment</a><li><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#b-production-flush-only-at-commit>b) Production – Flush Only at Commit</a><li><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#c-flush-at-the-last-order>c) Flush at the Last Order</a><li><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#d-flush-mid-loop>d) Flush Mid-Loop</a></ul><li class=parent><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#why-this-happened>Why This Happened</a><li class=parent><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#impact>Impact</a><li class=parent><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#the-fix>The Fix</a> <ul><li><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#1-removed-last-insert-id-entirely>1. Removed LAST_INSERT_ID() Entirely</a><li><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#2-generate-invoice-numbers-in-one-shot>2. Generate Invoice Numbers in One Shot</a></ul><li class=parent><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#why-tests-didn-t-catch-it>Why Tests Didn’t Catch It</a><li class=parent><a href=https://gagan405.github.io/posts/hibernate-sequence-native-query/#lessons-learned>Lessons Learned</a></ul></div></div>